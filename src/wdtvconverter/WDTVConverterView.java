/*
 * WDTVConverterView.java
 */

package wdtvconverter;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.util.Iterator;
import java.util.Properties;
import java.util.Vector;
import javax.swing.DefaultComboBoxModel;
import org.jdesktop.application.Action;
import org.jdesktop.application.SingleFrameApplication;
import org.jdesktop.application.FrameView;
import javax.swing.JDialog;
import javax.swing.JFileChooser;
import javax.swing.JFrame;
import javax.swing.JOptionPane;
//import javax.swing.UIManager;
import javax.swing.WindowConstants;
import javax.swing.filechooser.FileFilter;
import javax.swing.filechooser.FileNameExtensionFilter;
import javax.swing.table.DefaultTableModel;

/**
 * The application's main frame.
 */
public class WDTVConverterView extends FrameView {

    public WDTVConverterView(SingleFrameApplication app) {
        super(app);

        /*if (WDTVConverterApp.USER_OS.equals("Windows 7")) {
            try {
                UIManager.setLookAndFeel(
                        "javax.swing.plaf.metal.MetalLookAndFeel");
            } catch (Exception ex) {
            }
        }*/
        
        initComponents();

        getFrame().setResizable(false);

        for (Language lang : Constants.LANGUAGES.values()) {
            DefaultComboBoxModel dcbm = (DefaultComboBoxModel)
                    languageComboBox.getModel();
            dcbm.addElement(lang);
        }

        bitrateComboBox.setSelectedIndex(3);

        loadProperties();

        tempDirTextField.setText(tempDir.getAbsolutePath());
        
        getFrame().pack();

    }

    @Action
    public void showAboutBox() {
        if (aboutBox == null) {
            JFrame mainFrame = WDTVConverterApp.getApplication().getMainFrame();
            aboutBox = new WDTVConverterAboutBox(mainFrame);
            aboutBox.setLocationRelativeTo(mainFrame);
        }
        WDTVConverterApp.getApplication().show(aboutBox);
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        mainPanel = new javax.swing.JPanel();
        sourceTextField = new javax.swing.JTextField();
        destinationTextField = new javax.swing.JTextField();
        sourceButton = new javax.swing.JButton();
        destinationButton = new javax.swing.JButton();
        subsScrollPane = new javax.swing.JScrollPane();
        subsTable = new javax.swing.JTable();
        subtitleTextField = new javax.swing.JTextField();
        subtitleButton = new javax.swing.JButton();
        languageComboBox = new javax.swing.JComboBox();
        defaultCheckBox = new javax.swing.JCheckBox();
        sourceLabel = new javax.swing.JLabel();
        destinationLabel = new javax.swing.JLabel();
        additionalSubsLabel = new javax.swing.JLabel();
        audioBitrateLabel = new javax.swing.JLabel();
        bitrateComboBox = new javax.swing.JComboBox();
        kbitsLabel = new javax.swing.JLabel();
        runButton = new javax.swing.JButton();
        languageLabel = new javax.swing.JLabel();
        addButton = new javax.swing.JButton();
        removeButton = new javax.swing.JButton();
        tempDirLabel = new javax.swing.JLabel();
        tempDirTextField = new javax.swing.JTextField();
        tempDirButton = new javax.swing.JButton();
        menuBar = new javax.swing.JMenuBar();
        javax.swing.JMenu fileMenu = new javax.swing.JMenu();
        javax.swing.JMenuItem exitMenuItem = new javax.swing.JMenuItem();
        javax.swing.JMenu helpMenu = new javax.swing.JMenu();
        javax.swing.JMenuItem aboutMenuItem = new javax.swing.JMenuItem();
        fileChooser = new javax.swing.JFileChooser();
        outputDialog = new javax.swing.JDialog();
        outputScrollPane = new javax.swing.JScrollPane();
        outputTextArea = new javax.swing.JTextArea();

        mainPanel.setName("mainPanel"); // NOI18N

        sourceTextField.setEditable(false);
        org.jdesktop.application.ResourceMap resourceMap = org.jdesktop.application.Application.getInstance(wdtvconverter.WDTVConverterApp.class).getContext().getResourceMap(WDTVConverterView.class);
        sourceTextField.setText(resourceMap.getString("sourceTextField.text")); // NOI18N
        sourceTextField.setName("sourceTextField"); // NOI18N

        destinationTextField.setEditable(false);
        destinationTextField.setText(resourceMap.getString("destinationTextField.text")); // NOI18N
        destinationTextField.setName("destinationTextField"); // NOI18N

        sourceButton.setText(resourceMap.getString("sourceButton.text")); // NOI18N
        sourceButton.setName("sourceButton"); // NOI18N
        sourceButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                sourceButtonActionPerformed(evt);
            }
        });

        destinationButton.setText(resourceMap.getString("destinationButton.text")); // NOI18N
        destinationButton.setName("destinationButton"); // NOI18N
        destinationButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                destinationButtonActionPerformed(evt);
            }
        });

        subsScrollPane.setName("subsScrollPane"); // NOI18N

        subsTable.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "File", "Language", "Default"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.Object.class, java.lang.String.class, java.lang.Boolean.class
            };
            boolean[] canEdit = new boolean [] {
                false, false, false
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        subsTable.setName("subsTable"); // NOI18N
        subsTable.getTableHeader().setReorderingAllowed(false);
        subsScrollPane.setViewportView(subsTable);
        subsTable.getColumnModel().getColumn(0).setHeaderValue(resourceMap.getString("subsTable.columnModel.title0")); // NOI18N
        subsTable.getColumnModel().getColumn(1).setResizable(false);
        subsTable.getColumnModel().getColumn(1).setHeaderValue(resourceMap.getString("subsTable.columnModel.title1")); // NOI18N
        subsTable.getColumnModel().getColumn(2).setResizable(false);
        subsTable.getColumnModel().getColumn(2).setHeaderValue(resourceMap.getString("subsTable.columnModel.title2")); // NOI18N

        subtitleTextField.setEditable(false);
        subtitleTextField.setText(resourceMap.getString("subtitleTextField.text")); // NOI18N
        subtitleTextField.setName("subtitleTextField"); // NOI18N

        subtitleButton.setText(resourceMap.getString("subtitleButton.text")); // NOI18N
        subtitleButton.setName("subtitleButton"); // NOI18N
        subtitleButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                subtitleButtonActionPerformed(evt);
            }
        });

        languageComboBox.setModel(new DefaultComboBoxModel());
        languageComboBox.setName("languageComboBox"); // NOI18N

        defaultCheckBox.setText(resourceMap.getString("defaultCheckBox.text")); // NOI18N
        defaultCheckBox.setName("defaultCheckBox"); // NOI18N

        sourceLabel.setText(resourceMap.getString("sourceLabel.text")); // NOI18N
        sourceLabel.setName("sourceLabel"); // NOI18N

        destinationLabel.setText(resourceMap.getString("destinationLabel.text")); // NOI18N
        destinationLabel.setName("destinationLabel"); // NOI18N

        additionalSubsLabel.setText(resourceMap.getString("additionalSubsLabel.text")); // NOI18N
        additionalSubsLabel.setName("additionalSubsLabel"); // NOI18N

        audioBitrateLabel.setText(resourceMap.getString("audioBitrateLabel.text")); // NOI18N
        audioBitrateLabel.setName("audioBitrateLabel"); // NOI18N

        bitrateComboBox.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "192", "256", "384", "448", "640" }));
        bitrateComboBox.setName("bitrateComboBox"); // NOI18N

        kbitsLabel.setText(resourceMap.getString("kbitsLabel.text")); // NOI18N
        kbitsLabel.setName("kbitsLabel"); // NOI18N

        runButton.setText(resourceMap.getString("runButton.text")); // NOI18N
        runButton.setName("runButton"); // NOI18N
        runButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                runButtonActionPerformed(evt);
            }
        });

        languageLabel.setText(resourceMap.getString("languageLabel.text")); // NOI18N
        languageLabel.setName("languageLabel"); // NOI18N

        addButton.setText(resourceMap.getString("addButton.text")); // NOI18N
        addButton.setName("addButton"); // NOI18N
        addButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                addButtonActionPerformed(evt);
            }
        });

        removeButton.setText(resourceMap.getString("removeButton.text")); // NOI18N
        removeButton.setName("removeButton"); // NOI18N
        removeButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                removeButtonActionPerformed(evt);
            }
        });

        tempDirLabel.setText(resourceMap.getString("tempDirLabel.text")); // NOI18N
        tempDirLabel.setName("tempDirLabel"); // NOI18N

        tempDirTextField.setEditable(false);
        tempDirTextField.setText(resourceMap.getString("tempDirTextField.text")); // NOI18N
        tempDirTextField.setName("tempDirTextField"); // NOI18N

        tempDirButton.setText(resourceMap.getString("tempDirButton.text")); // NOI18N
        tempDirButton.setName("tempDirButton"); // NOI18N
        tempDirButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                tempDirButtonActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout mainPanelLayout = new javax.swing.GroupLayout(mainPanel);
        mainPanel.setLayout(mainPanelLayout);
        mainPanelLayout.setHorizontalGroup(
            mainPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(mainPanelLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(mainPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(mainPanelLayout.createSequentialGroup()
                        .addComponent(tempDirLabel)
                        .addGap(475, 475, 475))
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, mainPanelLayout.createSequentialGroup()
                        .addComponent(tempDirTextField, javax.swing.GroupLayout.DEFAULT_SIZE, 495, Short.MAX_VALUE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(tempDirButton, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addContainerGap())
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, mainPanelLayout.createSequentialGroup()
                        .addGroup(mainPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(subsScrollPane, javax.swing.GroupLayout.DEFAULT_SIZE, 568, Short.MAX_VALUE)
                            .addComponent(destinationLabel)
                            .addComponent(sourceLabel)
                            .addGroup(mainPanelLayout.createSequentialGroup()
                                .addComponent(audioBitrateLabel)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(bitrateComboBox, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(kbitsLabel))
                            .addGroup(mainPanelLayout.createSequentialGroup()
                                .addGroup(mainPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                    .addComponent(destinationTextField, javax.swing.GroupLayout.DEFAULT_SIZE, 495, Short.MAX_VALUE)
                                    .addComponent(sourceTextField, javax.swing.GroupLayout.DEFAULT_SIZE, 495, Short.MAX_VALUE))
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addGroup(mainPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                                    .addComponent(destinationButton, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                                    .addComponent(sourceButton, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)))
                            .addComponent(additionalSubsLabel)
                            .addGroup(mainPanelLayout.createSequentialGroup()
                                .addGap(1, 1, 1)
                                .addComponent(languageLabel)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(languageComboBox, 0, 262, Short.MAX_VALUE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(defaultCheckBox)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(addButton)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(removeButton)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(runButton))
                            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, mainPanelLayout.createSequentialGroup()
                                .addComponent(subtitleTextField, javax.swing.GroupLayout.DEFAULT_SIZE, 495, Short.MAX_VALUE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(subtitleButton)))
                        .addContainerGap())))
        );
        mainPanelLayout.setVerticalGroup(
            mainPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, mainPanelLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(tempDirLabel)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(mainPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(tempDirTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(tempDirButton))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(sourceLabel)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(mainPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(sourceTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(sourceButton))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(destinationLabel)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(mainPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(destinationTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(destinationButton))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(mainPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(audioBitrateLabel)
                    .addComponent(bitrateComboBox, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(kbitsLabel))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(additionalSubsLabel)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(subsScrollPane, javax.swing.GroupLayout.PREFERRED_SIZE, 137, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(7, 7, 7)
                .addGroup(mainPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(subtitleTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(subtitleButton))
                .addGap(9, 9, 9)
                .addGroup(mainPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(languageComboBox)
                    .addComponent(languageLabel)
                    .addComponent(runButton, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(removeButton)
                    .addComponent(addButton)
                    .addComponent(defaultCheckBox))
                .addGap(10, 10, 10))
        );

        menuBar.setName("menuBar"); // NOI18N

        fileMenu.setText(resourceMap.getString("fileMenu.text")); // NOI18N
        fileMenu.setName("fileMenu"); // NOI18N

        javax.swing.ActionMap actionMap = org.jdesktop.application.Application.getInstance(wdtvconverter.WDTVConverterApp.class).getContext().getActionMap(WDTVConverterView.class, this);
        exitMenuItem.setAction(actionMap.get("quit")); // NOI18N
        exitMenuItem.setName("exitMenuItem"); // NOI18N
        fileMenu.add(exitMenuItem);

        menuBar.add(fileMenu);

        helpMenu.setText(resourceMap.getString("helpMenu.text")); // NOI18N
        helpMenu.setName("helpMenu"); // NOI18N

        aboutMenuItem.setAction(actionMap.get("showAboutBox")); // NOI18N
        aboutMenuItem.setAccelerator(javax.swing.KeyStroke.getKeyStroke(java.awt.event.KeyEvent.VK_F1, 0));
        aboutMenuItem.setName("aboutMenuItem"); // NOI18N
        helpMenu.add(aboutMenuItem);

        menuBar.add(helpMenu);

        fileChooser.setName("fileChooser"); // NOI18N

        outputDialog.setTitle(resourceMap.getString("outputDialog.title")); // NOI18N
        outputDialog.setName("outputDialog"); // NOI18N

        outputScrollPane.setName("outputScrollPane"); // NOI18N

        outputTextArea.setColumns(20);
        outputTextArea.setEditable(false);
        outputTextArea.setRows(5);
        outputTextArea.setName("outputTextArea"); // NOI18N
        outputScrollPane.setViewportView(outputTextArea);

        javax.swing.GroupLayout outputDialogLayout = new javax.swing.GroupLayout(outputDialog.getContentPane());
        outputDialog.getContentPane().setLayout(outputDialogLayout);
        outputDialogLayout.setHorizontalGroup(
            outputDialogLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(outputScrollPane, javax.swing.GroupLayout.DEFAULT_SIZE, 400, Short.MAX_VALUE)
        );
        outputDialogLayout.setVerticalGroup(
            outputDialogLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(outputScrollPane, javax.swing.GroupLayout.DEFAULT_SIZE, 300, Short.MAX_VALUE)
        );

        setComponent(mainPanel);
        setMenuBar(menuBar);
    }// </editor-fold>//GEN-END:initComponents

    private void sourceButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_sourceButtonActionPerformed
        fileChooser.setSelectedFile(new File(""));
        fileChooser.setAcceptAllFileFilterUsed(false);
        fileChooser.setFileFilter(MKV_FILTER);
        fileChooser.setFileFilter(AVI_FILTER);
        int returnVal = fileChooser.showOpenDialog(this.getFrame());

        if (returnVal == JFileChooser.APPROVE_OPTION) {
            currentSource = fileChooser.getSelectedFile();
            sourceTextField.setText(currentSource.getAbsolutePath());
        }

        fileChooser.removeChoosableFileFilter(MKV_FILTER);
        fileChooser.removeChoosableFileFilter(AVI_FILTER);
        fileChooser.setAcceptAllFileFilterUsed(true);
    }//GEN-LAST:event_sourceButtonActionPerformed

    private void destinationButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_destinationButtonActionPerformed
        fileChooser.setSelectedFile(new File(""));
        if (currentSource == null) {
            JOptionPane.showMessageDialog(this.getFrame(),
                    "No source selected.",
                    "Error!", JOptionPane.ERROR_MESSAGE);
            return;
        }
        String dir = currentSource.getParentFile().getAbsolutePath();
        String name = currentSource.getName();
        int index = name.lastIndexOf(".");
        String realName = (index >= 0) ? name.substring(0, index) : name;
        fileChooser.setAcceptAllFileFilterUsed(false);
        fileChooser.setSelectedFile(new File(dir + "\\" + realName + ".mkv"));
        int prevType = fileChooser.getDialogType();
        fileChooser.setDialogType(JFileChooser.SAVE_DIALOG);
        fileChooser.setFileFilter(MKV_FILTER);
        int returnVal = fileChooser.showOpenDialog(this.getFrame());

        if (returnVal == JFileChooser.APPROVE_OPTION) {
            File f = fileChooser.getSelectedFile();
            name = f.getName();
            index = name.lastIndexOf(".");
            String ext = (index >= 0) ? name.substring(index + 1) : "";
            if (ext.isEmpty() || ext.compareToIgnoreCase("mkv") != 0) {
                String apath = f.getAbsolutePath();
                currentDestination = new File(apath +
                   ((index == name.length() - 1) ? "" : ".") + "mkv");
            } else currentDestination = f;
            destinationTextField.setText(currentDestination.getAbsolutePath());
        }
        fileChooser.removeChoosableFileFilter(MKV_FILTER);
        fileChooser.setDialogType(prevType);
        fileChooser.setAcceptAllFileFilterUsed(true);
    }//GEN-LAST:event_destinationButtonActionPerformed

    private void subtitleButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_subtitleButtonActionPerformed
        fileChooser.setSelectedFile(new File(""));
        fileChooser.setAcceptAllFileFilterUsed(false);
        fileChooser.setFileFilter(SRT_FILTER);
        int returnVal = fileChooser.showOpenDialog(this.getFrame());

        if (returnVal == JFileChooser.APPROVE_OPTION) {
            currentSubtitle = fileChooser.getSelectedFile();
            subtitleTextField.setText(currentSubtitle.getAbsolutePath());
        }
        fileChooser.removeChoosableFileFilter(SRT_FILTER);
        fileChooser.setAcceptAllFileFilterUsed(true);
    }//GEN-LAST:event_subtitleButtonActionPerformed

    private void addButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_addButtonActionPerformed
        if (currentSubtitle == null) return;
        DefaultTableModel dtm = (DefaultTableModel) subsTable.getModel();
        Language lang = (Language) languageComboBox.getSelectedItem();
        if (!hasSubtitle(currentSubtitle)) {
            if (defaultCheckBox.isSelected()) cleanDefault();
            dtm.addRow(new Object[]{ currentSubtitle,
                    lang , defaultCheckBox.isSelected() });
        }
    }//GEN-LAST:event_addButtonActionPerformed

    private void removeButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_removeButtonActionPerformed
        int index = subsTable.getSelectedRow();
        if (index < 0) return;
        DefaultTableModel dtm = (DefaultTableModel) subsTable.getModel();
        dtm.removeRow(index);
    }//GEN-LAST:event_removeButtonActionPerformed

    private void runButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_runButtonActionPerformed
        if (currentSource == null) {
            JOptionPane.showMessageDialog(this.getFrame(),
                    "No source selected.",
                    "Error!", JOptionPane.ERROR_MESSAGE);
            return;
        }
        if (currentDestination == null) {
            JOptionPane.showMessageDialog(this.getFrame(),
                    "No destination selected.",
                    "Error!", JOptionPane.ERROR_MESSAGE);
            return;
        }
        DefaultTableModel dtm = (DefaultTableModel) subsTable.getModel();
        Vector vv = dtm.getDataVector();
        Iterator it = vv.iterator();
        final Configuration conf = new Configuration();
        while(it.hasNext()) {
            Vector v = (Vector) it.next();
            File theFile = (File) v.get(0);
            Language lang = (Language) v.get(1);
            boolean isDefault = (Boolean) v.get(2);
            conf.addSubtitle(theFile, lang, isDefault);
        }
        conf.setBitRate(getCurrentBitrate());
        new Thread() {
            @Override
            public void run() {
                outputDialog.setModal(true);
                outputDialog.setDefaultCloseOperation(
                        WindowConstants.DO_NOTHING_ON_CLOSE);
                outputDialog.pack();
                outputDialog.setLocationRelativeTo(getFrame());
                outputDialog.setVisible(true);
            }
        }.start();
        new Thread() {
            @Override
            public void run() {
                try {
                    runButton.setEnabled(false);
                    long time = WDTVUtils.convert(currentSource,
                            currentDestination, conf, outputTextArea);
                    outputTextArea.setText("");
                    outputDialog.setVisible(false);
                    runButton.setEnabled(true);
                    JOptionPane.showMessageDialog(
                            WDTVConverterView.this.getFrame(),
                            "Completed in " + time/1000.0 + "s.",
                            "Done!", JOptionPane.INFORMATION_MESSAGE);
                } catch(Exception e) {
                    JOptionPane.showMessageDialog(
                            WDTVConverterView.this.getFrame(), e.toString(),
                    "Error!", JOptionPane.ERROR_MESSAGE);
                }
            }
        }.start();
    }//GEN-LAST:event_runButtonActionPerformed

    private void tempDirButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_tempDirButtonActionPerformed
        int prevSelectionMode = fileChooser.getFileSelectionMode();
        fileChooser.setFileSelectionMode(JFileChooser.DIRECTORIES_ONLY);
        int returnVal = fileChooser.showOpenDialog(this.getFrame());

        if (returnVal == JFileChooser.APPROVE_OPTION) {
            tempDir = fileChooser.getSelectedFile();
            tempDirTextField.setText(tempDir.getAbsolutePath());
            Constants.tempDir = tempDir.getAbsolutePath();
            props.put("tempDir", tempDir.getAbsolutePath());
            saveProperties();
        }

        fileChooser.setFileSelectionMode(prevSelectionMode);
    }//GEN-LAST:event_tempDirButtonActionPerformed

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton addButton;
    private javax.swing.JLabel additionalSubsLabel;
    private javax.swing.JLabel audioBitrateLabel;
    private javax.swing.JComboBox bitrateComboBox;
    private javax.swing.JCheckBox defaultCheckBox;
    private javax.swing.JButton destinationButton;
    private javax.swing.JLabel destinationLabel;
    private javax.swing.JTextField destinationTextField;
    private javax.swing.JFileChooser fileChooser;
    private javax.swing.JLabel kbitsLabel;
    private javax.swing.JComboBox languageComboBox;
    private javax.swing.JLabel languageLabel;
    private javax.swing.JPanel mainPanel;
    private javax.swing.JMenuBar menuBar;
    private javax.swing.JDialog outputDialog;
    private javax.swing.JScrollPane outputScrollPane;
    private javax.swing.JTextArea outputTextArea;
    private javax.swing.JButton removeButton;
    private javax.swing.JButton runButton;
    private javax.swing.JButton sourceButton;
    private javax.swing.JLabel sourceLabel;
    private javax.swing.JTextField sourceTextField;
    private javax.swing.JScrollPane subsScrollPane;
    private javax.swing.JTable subsTable;
    private javax.swing.JButton subtitleButton;
    private javax.swing.JTextField subtitleTextField;
    private javax.swing.JButton tempDirButton;
    private javax.swing.JLabel tempDirLabel;
    private javax.swing.JTextField tempDirTextField;
    // End of variables declaration//GEN-END:variables

    private JDialog aboutBox;
    private File currentSource;
    private File currentDestination;
    private File currentSubtitle;
    private Properties props;
    private File tempDir;

    private static final FileFilter SRT_FILTER = new
            FileNameExtensionFilter("Subtitles (.srt)", "srt");
    private static final FileFilter MKV_FILTER = new
            FileNameExtensionFilter("Matroska (.mkv)", "mkv");
    private static final FileFilter AVI_FILTER = new
            FileNameExtensionFilter("AVI (.avi)", "avi");

    private boolean hasSubtitle(File f) {
        DefaultTableModel dtm = (DefaultTableModel) subsTable.getModel();
        Vector vv = dtm.getDataVector();
        Iterator it = vv.iterator();
        while(it.hasNext()) {
            Vector v = (Vector) it.next();
            File theFile = (File) v.get(0);
            if (theFile.equals(f)) return true;
        }
        return false;
    }

    private int getCurrentBitrate() {
        int index = bitrateComboBox.getSelectedIndex();
        switch(index) {
            case 0: return Constants.BITRATE_192;
            case 1: return Constants.BITRATE_286;
            case 2: return Constants.BITRATE_384;
            case 3: return Constants.BITRATE_448;
            case 4: return Constants.BITRATE_640;
            default: return Constants.BITRATE_448;
        }
    }

    private void cleanDefault() {
        DefaultTableModel dtm = (DefaultTableModel) subsTable.getModel();
        Vector vv = dtm.getDataVector();
        Iterator it = vv.iterator();
        while(it.hasNext()) {
            Vector v = (Vector) it.next();
            boolean isDefault = (Boolean) v.get(2);
            if (isDefault) v.set(2, false);
        }
    }

    private void loadProperties() {
        try {
            ObjectInputStream ois = new ObjectInputStream(
                    new FileInputStream(new File(
                    WDTVConverterApp.USER_HOME + "\\" +
                    WDTVConverterApp.SETTINGS_DIR,
                    "wdtv.props")));
            props = (Properties) ois.readObject();
            ois.close();
            tempDir = new File((String) props.get("tempDir"));
            if (!tempDir.isDirectory()) {
                props.put("tempDir", WDTVConverterApp.USER_HOME + "\\" +
                                            WDTVConverterApp.SETTINGS_DIR);
                tempDir = new File(WDTVConverterApp.USER_HOME,
                        WDTVConverterApp.SETTINGS_DIR);
                saveProperties();
            }
        } catch (Exception ex) {
            props = new Properties();
            props.put("tempDir", WDTVConverterApp.USER_HOME + "\\" +
                                WDTVConverterApp.SETTINGS_DIR);
            tempDir = new File(WDTVConverterApp.USER_HOME,
                    WDTVConverterApp.SETTINGS_DIR);
            saveProperties();
        }
    }

    private void saveProperties() {
        try {
            ObjectOutputStream oos = new ObjectOutputStream(
                    new FileOutputStream(new File(
                    WDTVConverterApp.USER_HOME + "\\" +
                    WDTVConverterApp.SETTINGS_DIR,
                    "wdtv.props")));
            oos.writeObject(props);
            oos.flush();
            oos.close();
        } catch (Exception ex) {

        }
    }
    
}
